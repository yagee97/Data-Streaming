# Apache Kafka

아파치 카프카(Apache Kafka) 아키텍처 및 동작 방식, 파티션 읽기 쓰기

<br>

## 카프카(Kafka) 란?

아파치 카프카(Apache kafka)는 **분산 스트리밍 플랫폼**이며 데이터 파이프 라인을 만들 때 주로 사용되는 오픈 소스 솔루션 이다.

<br>

카프카는 **실시간 로그처리에 특화**되어 있는 솔루션이며 데이터를 유실없이 안전하게 전달하는 것이 주목적인 메시지 시스템에서 **Fault-Tolerant**한 안정적인 아키텍처와 **빠른 퍼포먼스**로 데이터를 처리할 수 있다.

<br>

### - 메시지 큐?

: 메시지 지향 미들웨어(Message Oriented Middleware: MOM)은 비동기 메시지를 사용하는 다른 응용 프로그램 사이의 데이터 송수신을 의미하는데 MOM을 구현한 시스템을 메시지 큐(Message Queue:MQ)라 한다.

<br>

<br>

## 카프카의 특징(Kafka Features)

#### 1) Publisher Subscriber 모델

 : Publisher Subscriber 모델은 **데이터 큐를 중간에 두고 서로 간 독립적**으로 데이터를 생산하고 소비한다. 이런 느슨한 결합을 통해 Publisher나 Subscriber가 죽을 시, 서로 간에 의존성이 없으므로 안정적으로 데이터를 처리할 수 있다. 또한, 설정 역시 간단하게 할 수 있다는 장점이 있다.

이 모델은 메시지를 특정 수신자에게 직접적으로 보내주는 시스템이 아니고, <u>메시지를 받기를 원하는 사람이 해당 토픽(Topic)을 구독함</u>으로써 메세지를 읽어올 수 있다.

<br>

* 기본 메시징 시스템에서는 브로커(Broker)(서버)가 컨슈머(Consumer)에게 메시지를 Push해주는 방식인데, **카프카는 컨슈머가 브로커로부터 메시지를 직접 가져가는 PULL 방식으로 동작**하기 때문에 컨슈머는 자신의 처리 능력만큼의 메시지만 가져와 최적의 성능을 낼 수 있다.

<br>

#### 2) 고가용성(High availability) 및 확장성(Scalability)

: 카프카는 <u>클러스터로서 작동</u>한다. 클러스터로서 작동하므로 **Fault-Tolerant** 한 고가용성 서비스를 제공할 수 있고 **분산 처리**를 통해 빠른 데이터 처리를 가능하게 한다.

또한, 서버를 수평적으로 늘려 안정성 및 성능을 향상시키는 **Scale-out**이 가능하다.

<br>

#### 3) 디스크 순차 저장 및 처리(Sequential Store and process in Disk)

: 메세지를 메모리 큐에 적재하는 기존 메세지 시스템과 다르게 카프카는 <u>메세지를 디스크에 순차적으로 저장</u>한다. 이로써 얻는 이점은 두 가지다.

> * 서버에 장애가 나도 메세지가 디스크에 저장되어 있으므로 유실걱정이 없다.
> * 디스크가 순차적으로 저장되어 있으므로 디스크 I/O가 줄어들어 성능이 빨라진다.
> * 일반적으로 디스크보다 메모리가 훨씬 빠르지만, 디스크의 순차적 읽기에 대한 성능은 메모리 보다 크게 떨어지지 않기 때문에 카프카 성능이 좋다고 말할 수 있는 것이다.

<br>

#### 4) 분산 처리(Distributed Processing)

: 카프카는 **파티션(Partition)**이란 개념을 도입하여 <u>여러개의 파티션을 서버들에 분산</u>시켜 나누어 처리할 수 있다. 이로써 메세지를 상황에 맞추어 빠르게 처리할 수 있다.

<br>

## 카프카 아키텍처 및 구성 (Kafka Architecture and Components)

 ![img](https://t1.daumcdn.net/cfile/tistory/99C4604A5C04D88805) 

카프카 클러스터를 중심으로 프로듀서와 컨슈머가 데이터를 **Push**하고 **Pull**하는 구조이다. Producer, Consumer는 각기 다른 프로세스에서 <u>비동기로 동작</u>하고 있다. 

<br>

#### <카프카 구성요소>

1) **프로듀서 (Producer)**: 데이터를 발생시키고 카프카 클러스터(Kafka Cluster)에 적재하는 프로세스

2) **카프카 클러스터 (Kafka Cluster)**: 카프카 서버로 이루어진 클러스터를 말함. 카프카 클러스터를 이루는 요소는 다음과 같다.

> * **브로커(Broker)**: 카프카 서버를 말함. 동일한 노드내에서 여러개의 Broker 서버를 띄울 수 있고, Zookeeper는 이러한 분산 메시지 큐의 정보를 관리해주는 역할을 한다. 카프카를 띄우기 위해서는 반드시 주키퍼가 실행되어야 한다.
> * **주키퍼(Zookeepr)**: 주키퍼는 분산 코디네이션 시스템이다. 카프카 브로커를 하나의 클러스터로 코디네이팅하는 역할을 하며 나중에 이야기할 카프카 클러스터의 리더(Leader)를 발탁하는 방식도 주키퍼가 제공하는 기능을 이용한다.
> * **토픽(Topic)**: 카프카에 저장되는 메시지는 Topic으로 분류되고, topic은 여러개의 Partition으로 나눠질 수 있다. Partition안에는 메시지의 상대적 위치를 나타내는 offset이 있는데 이 offset 정보를 이용해 이전에 가져간 메시지의 위치 정보를 알 수 있고 동시에 들어오는 많은 데이터를 여러개의 파티션에 나누어 저장하기 때문에 병렬로 빠르게 처리할 수 있다.
> * **파티션(Partition)**: 각 토픽 당 데이터를 분산 처리하는 단위다. 카프카에서는 토픽 안에 파티션을 나누어 그 수대로 데이터를 분산처리한다. 카프카 옵션에서 지정한 replica의 수 만큼 파티션이 각 서버들에게 복제된다.
> * **리더, 팔로워(Leader, Follower)**: 카프카에서는 각 파티션당 복제된 파티션 중에서 하나의 리더가 선출된다. 이 리더는 모든 읽기, 쓰기 연산을 담당하게 된다. 리더를 제외한 나머지는 팔로워가 되고 이 팔로워들은 단순히 리더의 데이터를 복사하는 역할만 하게 된다.
> * **컨슈머 그룹(Consumer Group)**: 컨슈머의 집합을 구성하는 단위이다. 카프카에서는 컨슈머 그룹으로서 데이터를 처리하며 컨슈머 그룹 안의 컨슈머 수만큼 파티션의 데이터를 분산 처리 하게 된다.

 ![img](https://t1.daumcdn.net/cfile/tistory/99725F4F5C04E42B35) 

<br>

위 그림은 **Producer**가 데이터를 카프카에 적재하고 있으며 그 저장된 데이터를 **Consumer Group A와 B**가 각각 자신이 처리하는 Topic을 가져오는 그림이다.

<br>

**Topic Foo**와 **Bar**는 각각 3개의 파티션으로 나뉘어져 있으며 이 각각의 파티션들은 `Replica=3`을 따라 3개의 복제본으로 복제된다.

복제본 중에는 하나의 리더가 선출되게 되고, 이 리더가 모든 데이터의 읽기, 쓰기 연산을 담당하게 된다.

카프카 클러스터에서 데이터를 가지고 올 때는 **컨슈머 그룹(Consumer Group)단위**로 가져오게 된다. 이 컨슈머 그룹은 자신이 가져와야하는 토픽 안의 파티션의 데이터를 **Pull**하게 되고 각각 컨슈머 그룹안의 컨슈머들이 파티션이 나뉘어져 있는 만큼 데이터를 처리하게 된다.

<br>

## 카프카 파티션 읽기, 쓰기(Read and Write)

 ![img](https://t1.daumcdn.net/cfile/tistory/9975B44F5C04E3290F) 

카프카에서의 읽기, 쓰기 연산은 카프카 클러스터 내의 **리더 파티션들에게만 적용**된다. 하늘색으로 칠해진 각 파티션들은 리더 파티션이며 이 파티션들에게 프로듀서가 쓰기 연산을 진행한다. 그리고 리더 파티션에 쓰기가 진행되고 난 후 업데이트 된 데이터는 각 파티션들의 복제본들에게로 본사된다.

<br>

 ![img](https://t1.daumcdn.net/cfile/tistory/9983E5495C04EF1D19) 

위 그림은 컨슈머 그룹 단위로 그룹 내 컨슈머들이 각각의 파티션의 데이터를 처리하는 모습을 나타낸 것이다. 

컨슈머들은 **컨슈머 그룹으로 나뉘어서 데이터를 분산 처리**하게 되고 같은 컨슈머 그룹 내에 있는 컨슈머끼리 같은 파티션의 데이터를 처리할 수 없다.

<br>

<br>

참고:  https://engkimbs.tistory.com/691 

 https://devtimes.com/bigdata/2019/01/18/what-is-kafka/ 